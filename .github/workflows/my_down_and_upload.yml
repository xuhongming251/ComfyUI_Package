name: Download

on:
  workflow_dispatch:
    inputs:
      file-url:
        description: 'URL'
        required: true
        default: ''
      file-name:
        description: 'file name'
        required: false
        default: ''

jobs:
  download-upload:
    runs-on: ubuntu-latest

    steps:
    - name: 使用 wget 下载文件
      run: |
        # 下载文件的目标文件名
        output_file="downloaded_file"
        
        # 使用 --progress=dot 获取下载进度
        wget --progress=dot -q ${{ github.event.inputs.file-url }} -O $output_file &
        
        # 获取 wget 进程的 PID
        pid=$!

        # 每5秒打印一次下载进度
        while kill -0 $pid 2>/dev/null; do
          # 查看 wget 的进度信息
          echo "下载进度："
          tail -n 10 $output_file.log # 显示 wget 的最新进度信息
          sleep 5
        done

        # 下载完成后输出文件路径
        echo "已下载文件: $output_file"

    - name: 解析文件名
      run: |
        # 使用 URL 解析出文件名（从 URL 中提取文件名）
        FILENAME=$(basename ${{ github.event.inputs.file-url }})
        echo "从 URL 中解析出的文件名: $FILENAME"
        # 如果没有提供自定义文件名，使用解析出的文件名
        if [ -z "${{ github.event.inputs.file-name }}" ]; then
          echo "没有提供自定义文件名，使用解析后的文件名。"
          echo "UPLOAD_FILE_NAME=$FILENAME" >> $GITHUB_ENV
        else
          echo "使用自定义文件名: ${{ github.event.inputs.file-name }}"
          echo "UPLOAD_FILE_NAME=${{ github.event.inputs.file-name }}" >> $GITHUB_ENV
        fi

    - name: 设置 ossutil
      uses: yizhoumo/setup-ossutil@v2
      with:
        ossutil-version: '1.7.18'
        endpoint: ${{ secrets.ALIYUN_OSS_ENDPOINT }}
        access-key-id: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
        access-key-secret: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

    - name: 上传文件到 OSS
      run: |
        echo "正在上传 $UPLOAD_FILE_NAME 到 OSS..."
        ossutil cp downloaded_file oss://xusharefile/download/$UPLOAD_FILE_NAME
